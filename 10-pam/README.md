# 10. PAM
## Задача:

1. Запретить всем пользователям, кроме группы admin логин в выходные и праздничные дни
2. Дать конкретному пользователю права рута.

## Решение

### Тестовый стенд ###

Разворачивается через [Vagrantfile](Vagrantfile)

У root пароль "vagrant"

Все тестовые пользователи, кроме root имеют пароль "1234":
- в группе **admin**: root, alexey, john;
- рядовые пользователи: jim, bob;
- john - добавлена возможность использования Linux-капабилити CAP_SYS_ADMIN, CAP_DAC_OVERRIDE* и других. Пользователь имеет право редактировать системные конфигурационные файлы через vi, включая /etc/sudoers и следовательно может получить root.

Вход по ssh тестировался при парольной аутентификации. Например, подключаемся командой от имени john:

`ssh john@192.168.33.10`

После повторного запуска новой машины Vagrant могут возникнуть проблемы с ключами ssh в папке ~/.ssh. В этом случае перегенерируем файл ~/.ssh/known_hosts

`ssh-keygen -R 192.168.33.10`

**День запуска тестового стенда Vagrant является праздничным днем!**

### Описание ###

**1. Запретить всем пользователям, кроме группы admin логин в выходные и праздничные дни.**

Реализовано с помощью: 
1) Стандартного модуля `pam_exec.so` (аналогичен модулю `pam_script.so`). Выполняет скрипт [login_script.sh](login_script.sh) после ввода логина пользователя локально или по ssh.
Модуль добавлен в конфигурационный файл /etc/pam.d/[system-auth](system-auth) и /etc/pam.d/[sshd](sshd)

`auth        required      pam_exec.so stdout /etc/security/login_script.sh `

2) Скрипта /etc/security/[login_script.sh](login_script.sh).
- Определяет, состоит ли аутентифицируемый пользователь в группе "admin".
- Определяет, является ли текущий день выходным/праздничным.
- В соответствии с этим выдает текстовое предупреждение и блокирует либо разрешает ввод пароля, если вход выполнен локально. 
В случае ssh-подключения текстовое предупреждение не предусмотрено, блокировка не группы "admin" происходит после ввода пароля.

3) Конфигурационного файла /etc/security/[holidays.conf](holidays.conf), в котором указываются праздничные дни в формате:

`holiday: дд.мм.гг`


**2. Дать конкретному пользователю права рута**

Реализовано с помощью cтандартного модуля `pam_cap.so`, который позволяет повышать привелегии процессов после аутентификации пользователя (в текущем примере - с помощью `su - ...`). Модуль добавлен в конфигурационный файл /etc/pam.d/[su](su).

`auth		optional	pam_cap.so`

Капабилити, соотвествующие пользователю указываются в файле `/etc/security/capability.conf`. Например, для пользователя john: 

````
cap_sys_admin,cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_ipc_lock,cap_net_admin,cap_setuid,cap_setgid john 
* none 
````

Аттрибуты капабилитис необходимо установить на исполняемые файлы (для процессов) в каталоге /bin. Соответственно, данные процессы смогут запускаться с повышенными превилегиями теми пользователями, кому данное капабилити назначено (либо вообще всеми пользователям). 

На стенде установлен атрибут `cap_dac_override` для редактора vi командой:

`setcap 'CAP_DAC_OVERRIDE+ei' /bin/vi`

Чтобы проверить, нужно залогиниться под пользователем john через `su -`, чтобы использовалась его собственная среда:

`su - john`

Проверяем добавленные капабилити для пользователя john с помощью команды `capsh --print`:

````
[john@host3 ~]$ capsh --print

Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_setgid,cap_setuid,cap_net_admin,cap_ipc_lock,cap_sys_admin+i

...
````

Проверяем аттрибуты капабилити исполняемого файла /bin/vi с помощью команды `getcap`:

````
[john@host3 ~]$ getcap /bin/vi

/bin/vi = cap_dac_override+ei
````

Теперь кроме root только пользователь john может редактировать любые системные файлы.







