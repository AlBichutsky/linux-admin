НАСТРОЙКА МАСТЕРА

1.
разрешаем слейву коннектиться к мастеру под юзером repuser

Добавляем в /var/lib/pgsql/11/data/pg_hba.conf в конец

host    replication     repuser         127.0.0.1/32  md5
host    replication     repuser         192.168.100.10/32  md5
host    replication     repuser         192.168.100.11/32  md5

2. 
Создаем  пользователя repuser для репликации и пароль:

# su postgres
$ psql
# CREATE USER repluser REPLICATION LOGIN CONNECTION LIMIT 2 ENCRYPTED PASSWORD 'ReplPass';
# \q
# exit

3.
Переименовываем /var/lib/pgsql/11/data/postgresql.conf в /var/lib/pgsql/11/data/postgresql.conf.back
Создаем новый файл /var/lib/pgsql/11/data/postgresql.conf с правами postgres:postgres и содержимым:

listen_addresses = '*'
hot_standby = on
wal_level = replica
wal_log_hints = on
max_replication_slots = 2
max_wal_senders = 4
wal_keep_segments = 64
archive_mode = on
archive_command = 'cp -i %p /var/lib/pgsql/11/data/archive/%f'

#4. 
#Создаем каталог для хранения архива

mkdir /var/lib/pgsql/11/data/archive
chown postgres:postgres /var/lib/pgsql/11/data/archive

5. 
Перезапускаем мастер
systemctl restart postgresql-11.service


НАСТРОЙКА СЛЕЙВА

1. Останавливаем сервер
systemctl stop postgresql-11.service

2. Удаляем содердимое папки 
rm -Rf /var/lib/pgsql/11/data/* 

3. Копируем данные с мастера (содердимое data) и генерируем файд recovery.conf c настройками:
echo "ReplPass" | su postgres -c "pg_basebackup --username=repluser --pgdata=/var/lib/pgsql/11/data --host=192.168.100.10 --wal-method=stream --write-recovery-conf --progress"

4. Добавляем строчку в /var/lib/pgsql/11/data/recovery.conf:

restore_command = 'cp /var/lib/pgsql/11/data/archive/%f "%p"'

5. Запускаем сервер
systemctl start postgresql-11.service

ПРОВЕРКИ:

На мастере:
=# select * from pg_stat_replication;

На слейве:
=# select * from pg_stat_wal_receiver;

Создать тестовую базу
На мастере заходим в командную оболочку Postgre:
sudo -u postgres psql

Создаем новую базу данных:
=# CREATE DATABASE repltest ENCODING='UTF8';

Теперь на вторичном сервере смотрим список баз:
sudo -u postgres psql

=# \l
Мы должны увидеть среди баз ту, которую создали на первичном сервере:

На мастере можно использовать следующий запрос для получения сведений о клиентах потоковой репликации:
SELECT *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) AS byte_lag FROM pg_stat_replication s;
