# 12. Logging
## Задание
Настраиваем центральный сервер для сбора логов.

В вагранте поднимаем 2 машины: web и log
На web поднимаем nginx.

На log настраиваем центральный лог сервер на любой системе на выбор
- journald.
- rsyslog.
- elk. 

Настраиваем аудит, следящий за изменением конфигов nginx. 

- все критичные логи с web должны собираться и локально и удаленно;
- все логи с nginx должны уходить на удаленный сервер (локально только критичные);
- логи аудита должны также уходить на удаленную систему.


* развернуть еще машину elk
и таким образом настроить 2 центральных лог системы elk и какую либо еще.
В elk должны уходить только логи nginx.
Во вторую систему все остальное.

Критерии оценки: 
- 4 - если присылают только логи скриншоты без вагранта;
- 5 - за полную настройку;
- 6 - если выполнено задание со звездочкой;

## Решение

Настроенный тестовый стенд разворачивается через [Vagrantfile](Vagrantfile).
Поднимаются хосты:
- клиентский хост web c nginx (192.168.111.12);
- лог-сервер log для сбора логов c web (192.168.111.10).

Основные логи хоста web:
- c параметрами по умолчанию пишутся локально в каталог `/var/log`;
- критичные с приоритетом warning и выше пишутся локально в файл `/var/log/important_events.log`;
- критичные с приоритетом warning и выше отправляются на сервер rsyslog (192.168.111.10) в каталог `/var/log/web`, где web - это %hostname%.

Логи nginx с хоста web:
- критичные - error.log с приоритетом warning и выше, а также access.log пишутся в каталог `/var/log/nginx/`;
- nginxerror.log, nginxaccess.log с приоритетом info и выше отправляются на сервер rsyslog (192.168.111.10) в каталог `/var/log/web`, где где web - это %hostname%.

Логи аудита auditd c хоста web:
- cобытия аудита по умолчанию пишутся локально в файл `/var/log/audit/auditd.log`;
- cобытия аудита в случае изменения конфига /etc/nginx/nginx.conf отправляются на сервер auditd (192.168.111.10) в файл `/var/log/audit/auditd.log` (соответственно, на сервере можно посмотреть записи командами aureport, ausearch);
- cлужебные логи auditd (ошибки конфигурации и т.д) отправляются на сервер rsyslog (192.168.111.10) в каталог `/var/log/web`, где web - это %hostname%. 

## Разворачивание тестового стенда
Развернуть тестовые хосты с помощью Vagrant:
```
$ vagrant up
```

## Проверка сбора основных логов на лог-сервере
Поскольку критичные события с приоритетом warning и выше регистрируются не часто, можно убедиться, что на лог-сервер уходят логи с приоритетом info и выше.
Для этого необходимо:
1. Авторизоваться на клиенте:
```
$ vagrant ssh web
$ sudo su
```
2. Открыть на редактирование конфиг `/etc/rsyslog.conf`:
```
vi /etc/rsyslog.conf
```
3. Изменить строчку: 
```
# Отправлять логи с приоритетом warnings и выше (err,crit,alert) на rsyslog-сервер
*.warning               @@192.168.111.10:514
```
на
```
# Отправлять логи с приоритетом warnings и выше (err,crit,alert) на rsyslog-сервер
*.info               @@192.168.111.10:514
```
4. Перезапустить rsyslog после изменений:
```
systemctl restart rsyslog
```
4. Авторизоваться на лог-сервере и убедиться, что появился каталог `/var/log/web` с логами - `systemd.log`, `rsyslog.log` и т.д.: 
```
$ vagrant ssh log
$ sudo su
$ ls -la /var/log/web
```

## Проверка сбора логов nginx на лог-сервере
1. Открыть в браузере начальную страницу nginx (nginx установлен на web): http://192.168.111.12
2. Авторизоваться на лог-сервере и убедиться, что в каталоге `/var/log/web` появились файлы `nginxerror.log`,`nginxaccess.log` 
```
$ vagrant ssh log
$ sudo su
$ ls -la /var/log/web
$ cat /var/log/web/nginxaccess.log
```

## Проверка сбора логов auditd на лог-сервере после изменений конфигурационного файла nginx.conf на клиенте.
1. Авторизоваться на клиенте:
```
$ vagrant ssh web
$ sudo su
```
2. Внести изменения в файле `nginx.conf`, например, добавить новую закомментированную строчку:
```
vi /etc/nginx/nginx.conf
```
3. Авторизоваться на лог-сервере:
```
$ vagrant ssh log
$ sudo su
```
4. Проверить регистрацию события изменения конфигурации nginx:
```
aureport -f
ausearch -a <номер события - значение из вывода предыдущей команды>
``` 