# 7. Работа с загрузчиком
## Задание

1. Попасть в систему без пароля несколькими способами
2. Установить систему с LVM, после чего переименовать VG
3. Добавить модуль в initrd

4(*). Сконфигурировать систему без отдельного раздела с /boot, а только с LVM

Репозиторий с пропатченым grub: https://yum.rumyantsev.com/centos/7/x86_64/

PV необходимо инициализировать с параметром --bootloaderareasize 1m

Критерии оценки: Описать действия, описать разницу между методами получения шелла в процессе загрузки.

Где получится - используем script, где не получается - словами или копипастой описываем действия.



### Решение
### 1. Попасть в систему без пароля несколькими способами.

#### Способ 1:

1) При загрузке системы нажимаем `e` - переходим к редактированию параметров загрузки GRUB.
2) В конце строки начинающийся с `linux16` добавляем параметр ядра `init=/bin/sh` и нажимаем `сtrl-x`. 
Загрузчику будет передано указание запустить стандартный шелл `/bin/sh` в качестве единственного процесса (вместо systemd). Соотвественно, логинимся без пароля, поскольку остальные процессы в этот момент не запущены.
3) Перемонтируем корневую фс в Read/Write, потом можно выполнить другие команды:

```` 
mount -o remount,rw / 
```` 

#### Способ 2:

1) При загрузке системы нажимаем `e` - переходим к редактированию параметров загрузки GRUB.  
2) В конце строки начинающейся с linux16 добавляем `rd.break` и нажимаем `сtrl-x`. Загрузка системы будет остановлена в момент Initramfs и запустится его шелл с ограниченным набором команд. 
Корень фс будет находиться в `/sysroot`.
3) Выполняем следующие действия:

Монтируем раздел `/sysroot` в режиме Read,Write:

```` 
mount -o remount,rw /sysroot 
````  

Выполним chroot, чтобы в новом изолированном окружении для него каталог `/sysroot` отображался как `/`.
Это необходимо для того, чтобы утилита `/bin/passwd` запускалась в нормальном режиме и могла находить файлы с паролями.

```` 
сhroot /sysroot 
````

Отключаем SELinux (параметр `SELINUX=disabled`):

```` 
vi /etc/selinux/config 
```` 

Меняем пароль root:

```` 
passwd root 
````

Вместо отключения SELinux можно выполнить команду (но может не сработать):

```` 
touch /.autorelabel 
````

#### Способ 3:

1) При загрузке системы нажимаем `e` - переходим к редактированию параметров загрузки GRUB.
2) В строке начинающейся с `linux16` заменим `ro` на `rw init=/sysroot/bin/sh` и нажимаем `сtrl-x`.

По аналогии со способом 2 запустится шелл Initrams `/bin/sh` внутри `/sysroot` и выполнится команда `mount -o remount,rw /sysroot`.

Можно также выполнить следующие действия:
 ```` 
 vi /etc/selinux/config # выставить параметр SELINUX=disabled

 chroot /sysroot

 passwd root

 # touch /.autorelabel # либо выполнить вместо отключения selinux
 ````

### 2. Установить систему с LVM, после чего переименовать VG

Подготовлен скрипт для смены VG [rename_vg.sh](rename_vg.sh) с описанием.


### 3. Добавить модуль в initrd

Добавлено изображение пингвина в выводе терминала:

[Скриншот с пингивном](pingvin.png)

Краткая инструкция для установки модуля:

1) Скрипты модулей хранятся в каталоге `/usr/lib/dracut/modules.d/`. 
Для того чтобы добавить свой модуль создаем там папку с именем `01test`:
````
mkdir /usr/lib/dracut/modules.d/01test 
```` 
2) В папку `01test` поместим 2 скрипта из репо Леонида:
- [module-setup.sh](https://gist.github.com/lalbrekht/e51b2580b47bb5a150bd1a002f16ae85), который устанавливает модуль и вызывает скрипт test.sh
- [test.sh](https://gist.github.com/lalbrekht/ac45d7a6c6856baea348e64fac43faf0), собственно сам вызываемый скрипт, в нём рисуется пингвинчик

3) Пересобираем образ initrd:
````
 mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)
````
или:
```` 
dracut -f -v 
````
4) Можно проверить/посмотреть, какие модули загружены в образ:
```` 
lsinitrd -m /boot/initramfs-$(uname -r).img | grep test
````
test

5) После чего можно пойти двумя путями для проверки:
- Перезагрузиться и руками выключить опции rghb и quiet и увидеть вывод.
- Либо отредактироватþ grub.cfg, убрав эти опции:
````
vi /etc/default/grub 
````
